---
title: "Figures"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE)
```

```{r}
library(tidyverse)
library(cowplot)
library(RcppCNPy)
source("/workdir/genomic-data-analysis/scripts/individual_pca_functions.R")
```

## Figure 1

#### Heterozygosity

Here, I am comparing heterozygosity estimated from:

1. polyG trimmed, relaxed read quality filtering of 20 (before)

2. sliding window trimmed, stringent read quality filtering of 33 (after)

Neither have transitions filtered, have a stringent maximum depth filter of 10, and a stringent mapping quality filter of 30.

```{r fig.width=7.5, fig.height=6.6}
sample_table <- read_tsv("../sample_lists/sample_table_merged.tsv")
rename_pop <- tibble(population = c("ITV2011", "KNG2011", "QQL2011"),
                     population_new =c("pop 1", "pop 2", "pop 3"))
for (i in 1:nrow(sample_table)){
  sample_seq_id <- sample_table$sample_seq_id[i]
  sample_id <- sample_table$sample_id_corrected[i]
  population <- sample_table$population[i]
  data_type <- sample_table$data_type[i]
  if (str_detect(data_type,"pe")){
    path <- str_c("../../cod/greenland-cod/angsd/heterozygosity/", sample_seq_id,  "_bt2_gadMor3_minq20_sorted_dedup_overlapclipped_realigned_mindp2_maxdp10_minq20_minmapq30")
    path_stringent <- str_c("../angsd/heterozygosity/", sample_seq_id,  "_bt2_gadMor3_sorted_dedup_overlapclipped_realigned_mindp2_maxdp10_minq33_minmapq30")
  } else {
    path <- str_c("../../cod/greenland-cod/angsd/heterozygosity/", sample_seq_id,  "_bt2_gadMor3_minq20_sorted_dedup_realigned_mindp2_maxdp10_minq20_minmapq30")
    path_stringent <- str_c("../angsd/heterozygosity/", sample_seq_id,  "_bt2_gadMor3_sorted_dedup_realigned_mindp2_maxdp10_minq33_minmapq30")
  }
  het_relaxed <- read_delim(str_c(path, ".ml"), col_names = F, delim = " ") %>% 
    transmute(n_sites=(X1+X2+X3), n_snp=X2, het=n_snp/n_sites) %>%
    mutate(sample_id=sample_id, population=population, data_type=data_type, type="Before")
  het_stringent_notrans <- read_delim(str_c(path_stringent, ".ml"), col_names = F, delim = " ") %>% 
    transmute(n_sites=(X1+X2+X3), n_snp=X2, het=n_snp/n_sites) %>%
    mutate(sample_id=sample_id, population=population, data_type=data_type, type="After")
  het_combined <- bind_rows(het_relaxed, het_stringent_notrans)
  if(i==1){
    het_final <- het_combined
  } else {
    het_final <- bind_rows(het_final, het_combined)
  }
}
het_gg <- het_final %>%
  left_join(rename_pop) %>%
  mutate(type=fct_relevel(type, c("Before", "After"))) %>%
  mutate(batch=ifelse(data_type=="pe", "NextSeq-150PE", "HiSeq-125SE")) 
set.seed(42)
het_plot <- het_gg %>%
  filter(population %in% c("KNG2011", "QQL2011", "ITV2011")) %>%
  ggplot(aes(x=population, y=het)) +
  geom_boxplot(outlier.alpha = 0, color="black", size=0.2, width=0.2) +
  #geom_jitter(data=(het_gg %>% dplyr::select(-population_new) %>% filter(! population %in% c("KNG2011", "QQL2011", "ITV2011"))) , color="grey", height = 0, width = 0.3, size=1) +
  geom_jitter(aes(color=batch), height = 0, width = 0.1, size=2) +
  scale_color_viridis_d(begin=0.25, end=0.75) +
  ylab("heterozygosity") +
  facet_grid(population_new~type, scales = "free_y") +
  xlab(" ") +
  #scale_y_continuous(limits = c(0, 0.005), breaks = 0.001*(0:5), labels = c("0", "0.001", "0.002", "0.003", "0.004", "0.005")) +
  coord_flip() +
  theme_cowplot() +
  theme(panel.background=element_rect(colour="black", size=0.8),
        legend.position = c(0.78, 0.94),
        legend.key.size = unit(0.5, 'lines'),
        strip.text.x = element_text(face = "bold", size=20),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        legend.key = element_rect(fill = "white", colour = "black"))
het_plot
```

#### PCA

Here, I am comparing PCA result from 

1. the original LD pruned SNP list

2. a subsetted SNP list with private SNPs in each batch (those that are fixed in one batch and are at intermediate frequency in the other batch) and SNPs with depth ratio < 0.9 filtered out

Both have gone through sliding window trimming, have base quality and mapping quality filters of 20, minimum individual filter of 20, and etc. Both PCA are performed through ANGSD's `-doCov 1`.

Also, note that two outlier individuals from UUM2010 are removed from these plots for clearer results. 

```{r include=TRUE}
genome_cov <- read_tsv("../angsd/bam_list_realigned_downsampled_unlinked.covMat", col_names = F) %>%
  as.matrix()
PCA(genome_cov, sample_table$sample_id_corrected, sample_table$data_type, 1, 2, show.ellipse = F, show.line = F)
pca_before <- pca_table[,1:4] %>%
  rename(data_type=population) %>%
  left_join(transmute(sample_table, individual=sample_id_corrected, population=population)) %>%
  mutate(PC2=-PC2)

genome_cov <- read_tsv("../angsd/bam_list_realigned_private_snps_depth_ratio_filtered.covMat", col_names = F) %>%
  as.matrix()
PCA(genome_cov, sample_table$sample_id_corrected, sample_table$data_type, 1, 2, show.ellipse = F, show.line = F)
pca_after <- pca_table[,1:4] %>%
  rename(data_type=population) %>%
  left_join(transmute(sample_table, individual=sample_id_corrected, population=population))
```

```{r fig.width=7.5, fig.height=6.6}
pca_combined <- bind_rows(bind_cols(pca_before, type="Before"), 
                          bind_cols(pca_after, type="After")) %>%
  mutate(type=fct_relevel(type, c("Before", "After"))) %>%
  mutate(batch=ifelse(data_type=="se", "HiSeq-125SE", "NextSeq-150PE"))
pca_combined_select_pops <- filter(pca_combined, population %in% c("KNG2011", "QQL2011", "ITV2011"))
pca_plot <- pca_combined_select_pops %>%
  left_join(rename_pop) %>%
  ggplot(aes(x=PC1, y=PC2)) +
  geom_point(data=pca_combined, color="grey", size=0.5) +
  geom_point(aes(color=batch), size=2) +
  scale_color_viridis_d(begin=0.25, end=0.75) +
  facet_grid(population_new~type) +
  ylim(NA, 0.15) +
  xlim(-0.15, NA) +
  theme_cowplot() +
  theme(axis.text = element_blank(),
        axis.ticks = element_blank(),
        panel.border = element_rect(colour="black",size=0.5),
        legend.position = c(0.78, 0.94),
        legend.key.size = unit(0.5, 'lines'),
        strip.text.x = element_text(face = "bold", size=20),
        legend.key = element_rect(fill = "white", colour = "black"))
pca_plot
```

#### Fst

Here, I am plotting Fst estimated from sliding window trimmed data with relaxed mapping quality and read quality filter (both 20). There is a minimum number of individuals filter of 20 for both batches of data. I compare the Fst result before and after applying a depth ratio filter of 0.9. 

```{r fig.width=15, fig.height=3.3}
fixed_windowed_fst <- function(x, window_length){
  mutate(x, position=cut(position, breaks=seq(0,50*10^6,window_length), labels=seq(window_length/2,50*10^6-window_length/2,window_length))) %>%
  group_by(lg, position, type) %>%
  summarise(fst=sum(alpha)/sum(beta)) %>%
  mutate(position=as.numeric(as.character(position)))
}
maf_se <- read_tsv("../angsd/popminind20/se_global_snp_list_bam_list_realigned_mindp46_maxdp184_minind20_minq20_popminind20.mafs.gz") %>%
  transmute(lg = chromo, position = position, major=major, minor = minor, se_maf = knownEM, se_nind=nInd)
maf_pe <- read_tsv("../angsd/popminind20/pe_global_snp_list_bam_list_realigned_mindp46_maxdp184_minind20_minq20_popminind20.mafs.gz")%>%
  transmute(lg = chromo, position = position, major=major, minor = minor, pe_maf = knownEM, pe_nind=nInd)
fst <- read_tsv("../angsd/popminind20/pe_se_global_snp_list_bam_list_realigned_mindp46_maxdp184_minind20_minq20_popminind20.alpha_beta.txt", col_names = F) %>%
  mutate(X5=X3/X4) %>%
  transmute(lg=X1, position = X2, alpha=X3, beta=X4, fst = X5)
anymapq_depth <- read_tsv("../angsd/popminind2/bam_list_realigned_se_anymapq.pos.gz") %>%
  rename(lg=chr, position=pos, total_depth_anymapq=totDepth)
mapq20_depth <- read_tsv("../angsd/popminind20/se_global_snp_list_bam_list_realigned_mindp46_maxdp184_minind20_minq20_popminind20.pos.gz") %>%
  rename(lg=chr, position=pos, total_depth_mapq20=totDepth)
maf_joined <- inner_join(maf_se, maf_pe) %>%
  left_join(fst) %>%
  filter(str_detect(lg, "LG"))
depth <- inner_join(anymapq_depth, mapq20_depth) %>%
  mutate(depth_ratio=total_depth_mapq20/total_depth_anymapq)
fst_combined <- maf_joined %>%
  left_join(depth) %>%
  filter(depth_ratio > 0.9) %>%
  mutate(type="After") %>%
  bind_rows(maf_joined %>% left_join(depth) %>% mutate(type="Before")) %>%
  mutate(type=fct_relevel(type, c("Before", "After")))
## per SNP
fst_plot <- fst_combined %>%
  ggplot(aes(x=position/10^6, y=fst, color=lg)) +
  geom_point(size = 0.5) +
  scale_color_manual(values = rep(c("black", "darkgrey"), 12)) +
  scale_x_continuous(breaks = c(0,15)) +
  facet_grid(type~lg, scales = "free_x", space = "free_x") +
  xlab("position (in Mb)") +
  ylab("Fst") +
  theme_cowplot() +
  theme(panel.spacing = unit(0.0, "lines")) +
  theme(legend.position = "none",
        strip.text.y = element_text(face = "bold", size=15))
fst_plot
## in 10kb windows
fst_combined %>%
  fixed_windowed_fst(10000) %>%
  ggplot(aes(x=position/10^6, y=fst, color=lg)) +
  geom_point(size = 0.5) +
  scale_color_manual(values = rep(c("black", "darkgrey"), 12)) +
  scale_x_continuous(breaks = c(0,15)) +
  facet_grid(type~lg, scales = "free_x", space = "free_x") +
  xlab("position (in Mb)") +
  ylab("Fst") +
  theme_cowplot() +
  theme(panel.spacing = unit(0.0, "lines")) +
  theme(legend.position = "none",
        strip.text.y = element_text(face = "bold", size=15))
```

#### Combine the plots

```{r fig.width=15, fig.height=10}
top <- plot_grid(het_plot, pca_plot, labels = c('A', 'B'), label_size = 20)
plot_grid(top, fst_plot, labels = c(NA, 'C'), label_size = 20, nrow = 2, rel_heights = c(1, 0.5))
```

